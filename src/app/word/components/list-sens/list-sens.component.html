<div class="list-sens">
    <mat-card>
        <mat-card-header>
            <mat-card-title>{{ 'word.senseList.title' | translate }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="list-sens__toolbar">
                <mat-form-field appearance="outline" class="list-sens__field">
                    <mat-label>{{ 'word.form.type.label' | translate }}</mat-label>
                    <mat-select
                        [value]="selectedTypeId()"
                        (selectionChange)="onTypeChange($event.value)"
                    >
                        <mat-option [value]="null">{{ 'word.senseList.placeholder' | translate }}</mat-option>
                        <mat-option *ngFor="let type of types()" [value]="type.id">
                            {{ type.name }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <button
                    mat-stroked-button
                    color="primary"
                    class="list-sens__download"
                    (click)="downloadTxt()"
                    [disabled]="status() !== 'loaded' || words().length === 0"
                >
                    Download TXT
                </button>
                <button
                    mat-flat-button
                    color="primary"
                    class="list-sens__chatgpt"
                    (click)="triggerChatGpt()"
                    [disabled]="!selectedTypeId() || aiLoading()"
                >
                    ChatGPT
                </button>
                <span class="list-sens__status" *ngIf="aiJobStatus() as status">
                    AI: {{ status.status }} ({{ status.completedBatches }}/{{ status.batches }})
                </span>
            </div>
            <div class="list-sens__ai-error" *ngIf="aiJobFirstError() as error">
                <div class="list-sens__ai-error-title">Erreur OpenAI (lot {{ error.batchIndex + 1 }})</div>
                <div class="list-sens__ai-error-message">{{ error.message }}</div>
                <pre class="list-sens__ai-error-raw">{{ error.raw }}</pre>
                <div class="list-sens__ai-error-file" *ngIf="error.rawFile">Fichier brut: {{ error.rawFile }}</div>
            </div>
            <div class="list-sens__ai-error" *ngIf="aiJobFirstImportError() as error">
                <div class="list-sens__ai-error-title">Erreur import (wordLangueType {{ error.wordLangueTypeId ?? '-' }})</div>
                <div class="list-sens__ai-error-message">{{ error.message }}</div>
            </div>

            <ng-container *ngIf="selectedTypeId(); else noSelection">
                <div class="list-sens__content">
                    <div *ngIf="status() === 'loaded'" class="list-sens__count">
                        {{ words().length }} r√©sultat(s)
                    </div>
                    <mat-progress-spinner
                        *ngIf="status() === 'loading'"
                        mode="indeterminate"
                        diameter="36"
                        class="list-sens__spinner"
                    ></mat-progress-spinner>

                    <div *ngIf="status() !== 'loading'">
                        <div *ngFor="let block of wordBlocks(); let last = last" class="list-sens__block">
                            <mat-list>
                                <mat-list-item *ngFor="let word of block; trackBy: trackByWord">
                                    {{ displayWord(word) }}
                                </mat-list-item>
                            </mat-list>
                            <mat-divider *ngIf="!last"></mat-divider>
                        </div>
                    </div>

                    <div class="list-sens__empty" *ngIf="status() === 'loaded' && words().length === 0">
                        {{ 'word.senseList.empty' | translate }}
                    </div>
                </div>
            </ng-container>

            <ng-template #noSelection>
                <div class="list-sens__hint">{{ 'word.senseList.hint' | translate }}</div>
            </ng-template>
        </mat-card-content>
    </mat-card>
</div>
